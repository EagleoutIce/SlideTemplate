% =============================================
% MAIN uulm-THEME
% =============================================

% ---------------------------------------------
% import packages
% ---------------------------------------------
\usepackage[utf8]{inputenc}
\usepackage{xargs} % used to define/renew commands with multiple optional parameters
\usepackage{color}
\usepackage{fitbox} % used to auto-scale long frame titles
\usepackage{tcolorbox} % used for color boxes (definition, example, note)
\usepackage{ifthen}
\usepackage{microtype} % balance text
% ---------------------------------------------


% ---------------------------------------------
% general settings
% ---------------------------------------------
\beamertemplatenavigationsymbolsempty % remove the default navigation symbols
\def\ThemeLetter#1{\def\@tmp{#1}\ifx\@tmp\@empty\let\@theme@letter@title\@empty \let\@theme@letter@page\@empty\else\def\@theme@letter@title{#1.\space}\def\@theme@letter@page{#1--}\fi}
\ThemeLetter{}

\appto\Ginput@path{{../pics/logos}{../pics/uulm}{../pics/nature}}

\newif\ifrecording % for enabling or disabling recording mode

\setlength{\parskip}{1.5ex} % set the parskip
\newcommand{\@minipagerestore}{\setlength{\parskip}{1.5ex}} % use parskip also in minipages (also used for tcolorbox)
% ---------------------------------------------


% ---------------------------------------------
% colors
% ---------------------------------------------
% uulm color scheme:
\definecolor{black}{HTML}{000000}
\definecolor{uulmlogoblue}{HTML}{89a2b3}
\definecolor{uulmblue}{HTML}{7D9AAA}
\definecolor{uulmaccent}{HTML}{A9A28D}
\definecolor{green}{HTML}{56AA1C}
\definecolor{red}{HTML}{A32638}
\definecolor{orange}{HTML}{DF6D07}
\definecolor{blue}{HTML}{26547C}

% beamer colors:
\setbeamercolor{frametitle}{fg=black}
\setbeamercolor{myfooter}{fg=white,bg=uulmaccent}
\setbeamercolor{mypagenumber}{fg=white,bg=red}
\setbeamercolor{titlebox}{fg=white,bg=red}
\setbeamercolor{subtitlebox}{fg=white,bg=uulmaccent}
\setbeamercolor{logobox}{bg=white}
\setbeamercolor{section in toc}{fg=black}
\setbeamercolor{subsection in toc}{fg=black}

\setbeamercolor{section in head/foot}{parent=myfooter}

\newcommand{\setfaculty}[1]{
    \ifthenelse{\equal{#1}{med}}{\setbeamercolor{mypagenumber}{fg=white,bg=blue}\setbeamercolor{titlebox}{fg=white,bg=blue}}{
        \ifthenelse{\equal{#1}{infIngPsy}}{\setbeamercolor{mypagenumber}{fg=white,bg=red}\setbeamercolor{titlebox}{fg=white,bg=red}}{
            \ifthenelse{\equal{#1}{math}}{\setbeamercolor{mypagenumber}{fg=white,bg=green}\setbeamercolor{titlebox}{fg=white,bg=green}}{
                \ifthenelse{\equal{#1}{nat}}{\setbeamercolor{mypagenumber}{fg=white,bg=orange}\setbeamercolor{titlebox}{fg=white,bg=orange}}{}
            }
        }
    }
}
% ---------------------------------------------


% ---------------------------------------------
% fonts
% ---------------------------------------------
\setbeamerfont{frametitle}{size=\LARGE, series=\bfseries}
\setbeamerfont{section in toc}{size=\large, series=\bfseries}

% we could use this to reduce section space
% \patchcmd{\beamer@sectionintoc}{\vskip1.5em}{\vskip1em}\relax{\typeout{section patch failed}}

\setbeamerfont{itemize/enumerate subbody}{size=\normalsize}
\setbeamerfont{itemize/enumerate subsubbody}{size=\normalsize}
% ---------------------------------------------


% ---------------------------------------------
% list environments
% ---------------------------------------------
\setbeamercolor{item}{fg=black}
\setbeamertemplate{itemize items}[circle]
\setbeamertemplate{enumerate item}{\arabic{enumi}.}
\setbeamertemplate{enumerate subitem}{\arabic{enumii}.}
\setbeamertemplate{enumerate subsubitem}{\arabic{enumiii}.}
\setbeamertemplate{section in toc}[sections numbered]
% ---------------------------------------------


% ---------------------------------------------
% frame layout
% ---------------------------------------------
\renewcommandx{\maketitle}[2][1=apr21-o25a,2=150]{
    {
    \usebackgroundtemplate{\includegraphics[trim=0 0 0 #2,clip,width=\paperwidth]{#1}}
    \begin{frame}[plain]
        \vskip0pt plus 1filll
        \begin{beamercolorbox}[wd=\paperwidth,ht=4.5ex,dp=2ex,right]{titlebox}
            \LARGE\textbf{\@theme@letter@title\inserttitle}\hspace*{20pt}
        \end{beamercolorbox}%
        \nointerlineskip%
        \begin{beamercolorbox}[wd=\paperwidth,ht=2.25ex,dp=1ex,right]{subtitlebox}
            \small
            \ifx\insertsubtitle\empty\else\insertsubtitle\ $\vert$ \fi
            \insertauthor\
            \ifx\insertdate\empty\else $\vert$ \insertdate \fi
            \hspace*{20pt}
        \end{beamercolorbox}%
        \nointerlineskip
        \begin{beamercolorbox}[wd=\paperwidth,ht=4.5ex,dp=2ex,left]{logobox}
            \centering
            \vspace{-1ex}
            \hspace{10pt}
            \includegraphics[height=4.5ex]{sp} % SPECIFY INSTITUTE LOGO HERE
            \hfill
            \includegraphics[height=4.5ex]{uulm}
            \hspace{10pt}
        \end{beamercolorbox}%
    \end{frame}
    }
}

\setbeamertemplate{frametitle}{
    \vspace{20pt}%
    \setbox0=\hbox{\insertframetitle}%
    \ifdim\wd0<\textwidth % <- in this case we want to allow hfill etc. to work normally
    \insertframetitle
    \else\let\hfill\space\resizebox\linewidth!{\insertframetitle}\fi
}

% TODO: maybe jumpers for first and last slide?
\def\uulm@guard@@ssect#1{\expandafter\gdef\csname uulm@guard@sect@#1\endcsname{X}}
\def\uulm@guard@ssect#1{\uulm@guard@@ssect{#1}\immediate\write\@auxout{\string\uulm@guard@@ssect{#1}}}
\long\def\beamer@@ssection*#1{\global\advance\uulm@unstarred@sec@counter\m@ne\uulm@guard@ssect{\the\numexpr\c@section+1}\beamer@section[{#1}]{}}
\newcount\uulm@unstarred@sec@counter
\let\uulm@base@sect\beamer@section
\long\def\beamer@section[#1]#2{\global\advance\uulm@unstarred@sec@counter\@ne\uulm@base@sect[#1]{#2}}
% \show\section
% TODO: hook to real
\def\uulm@sectionentry#1#2#3#4#5{% section number, section title, page
  \beamer@xpos=0\relax
  \beamer@ypos=1\relax
  \beamer@ypos@offset=0\relax
  \ifnum#5=\c@part
  \ifcsname uulm@guard@sect@#1\endcsname\else
  \beamer@section@set@min@width
  \box\beamer@sectionbox\hskip2.5ex plus .2\linewidth% i do not want full fill
  \setbox\beamer@sectionbox=
  \hbox{\def\insertsectionhead{#2}%
    \def\insertsectionheadnumber{#1}%
    \def\insertpartheadnumber{#5}%
    {%
      \usebeamerfont{section in head/foot}\usebeamercolor[fg]{section in head/foot}%
      \ifnum\c@section=#1%
        \hyperlink{Navigation#3}{{\usebeamertemplate{section in head/foot}}}%
      \else%
        \hyperlink{Navigation#3}{{\usebeamertemplate{section in head/foot shaded}}}%
      \fi}%
  }%
  \ht\beamer@sectionbox=2.5ex%
  \dp\beamer@sectionbox=0.75ex%
  \fi\fi\ignorespaces
}
\def\@gobble@six#1#2#3#4#5#6{}
% TODO: maybe progress-bar below each section? may be something for the future

\def\uulm@sections@low{{%
\beamer@currentsubsection0\relax
\let\sectionentry\uulm@sectionentry
\let\slideentry\@gobble@six
\setbox0=\hbox{\uulm@pre@footer}\relax
\insertnavigation{\dimexpr.9\linewidth-\wd0}}}

\def\uulm@pre@footer{\insertshortauthor}
\def\uulm@footer{\uulm@pre@footer\hfill\uulm@sections@low} % allows context redefinition
% TODO: maybe right align this as well by using fixed widths?
\def\uulm@section@footer{\uulm@pre@footer\hfill\insertshorttitle\ \ifx\insertshortsubtitle\@empty\else{--- \insertshortsubtitle\ }\fi\ifx\insertsectionhead\@empty\else{--- \thesection.~\insertsectionhead}\fi}
\setbeamertemplate{footline}{
    \hbox{%
        \begin{beamercolorbox}[wd=0.93\paperwidth,ht=3mm,dp=1.5mm,left]{myfooter}
            \hskip.03\paperwidth
            \uulm@footer
            %
            \hskip.03\paperwidth
        \end{beamercolorbox}%
        \begin{beamercolorbox}[wd=0.07\paperwidth,ht=3mm,dp=1.5mm,center]{mypagenumber}
            \usebeamerfont{page number in head/foot}\@theme@letter@page\insertframenumber\ifnum\insertframestartpage=\insertframeendpage\else\rlap{\color{fg!50!bg}.\insertslidenumber}\fi
        \end{beamercolorbox}%
    }%
}
% ---------------------------------------------


% ---------------------------------------------
% table of contents
% ---------------------------------------------
\AtEndDocument{\immediate\write\@auxout{\string\xdef\string\uulm@totalsections{\the\uulm@unstarred@sec@counter}}}
\def\uulm@totalsections{\the\uulm@unstarred@sec@counter}
\def\uulmdefaulttocsplit{5}
% other options | split at X
\def\uulmtoccolwrap#1{\vfill\vfill#1\vfill}
% \def\uulmtoccolwrap#1{#1} => top
\newcommand\uulmtoc[2][\uulmdefaulttocsplit]{%
\hb@xt@\linewidth{\hb@xt@.5\linewidth{\vbox to.8\textheight{\uulmtoccolwrap{\tableofcontents[sections={1-#1},#2]}}}%
\hb@xt@.5\linewidth{\vbox to.8\textheight{\edef\@start{\the\numexpr#1+1}\uulmtoccolwrap{\tableofcontents[sections={\@start-\uulm@totalsections},#2]}}}}%
}
\AtBeginSection[]{\begingroup
    \let\uulm@footer\uulm@section@footer
    \begin{frame}[c]{\thesection.~\insertsection}
        \setlength{\parskip}{0ex}
        \uulmtoc{currentsection,hideothersubsections}
    \end{frame}
    \endgroup
}

% clone clone :D
\newcommand{\lectureoverview}{\begingroup
    \let\uulm@footer\uulm@section@footer
    \begin{frame}[c]{\@theme@letter@title\inserttitle}
        \setlength{\parskip}{0ex}
        \uulmtoc{}
    \end{frame}
    \endgroup
}
% ---------------------------------------------


% ---------------------------------------------
% content layout
% ---------------------------------------------
\newcommand{\halfpage}[1]{\partofpage{48}{#1}}

\newcommand{\thirdpage}[1]{\partofpage{31}{#1}}

\usepackage{adjustbox}
\newcommand{\partofpage}[2]{
	\begin{minipage}{0.#1\textwidth}
			\begin{flushleft}
				#2
			\end{flushleft}
	\end{minipage}
}

% macro name [and text] | number of old args | old definition
% | new definition (next-target only,no args => next)
\long\def\uulm@CreateSplitterBox#1#2#3#4{%
\@namedef{uulm@txt@#1}{#1}
\edef\@tmp{\noexpand\@namedef{#1}{%
\noexpand\ifx\expandonce{\csname uulm@txt@#1\endcsname}\noexpand\@currenvir\noexpand\expandafter\expandonce{\csname uulm@#1\endcsname}\noexpand\else\noexpand\expandafter\expandonce{\csname uulm@old@#1\endcsname}\noexpand\fi}}
\@tmp
\expandafter\newcommand\csname uulm@old@#1\endcsname[#2]{#3}
\@namedef{uulm@#1}{\columns[c,onlytextwidth]\def\next{#4}\next}
\@namedef{end#1}{\endcolumns}
}
\uulm@CreateSplitterBox{leftandright}{2}{\halfpage{#1}\hfill\halfpage{#2}}{\column{.48\textwidth}}

% the old version allowed to pass on three macros, we want to support this non-verbatim-safe
% variant for legacy reasons. With '\@ifnextchar\bgroup' we could check if this macro
% is followed by an open brace. This is fragile, because we do no longer separate between
% protective groups and the plain definition. Assuming, that no non-export user will
% use plain macro definitions, we will use currenvir guards.
\def\uulm@txt@leftmiddleandright{leftmiddleandright}%
\def\leftmiddleandright{\ifx\@currenvir\uulm@txt@leftmiddleandright\expandafter\uulm@leftmiddleright\else\expandafter\uulm@old@leftmiddleright\fi}
\def\uulm@old@leftmiddleright#1#2#3{%
	\thirdpage{#1}%
    \hfill
    \thirdpage{#2}%
    \hfill
    \thirdpage{#3}%
}
% TODO: to be honest, it would be better to patch the old variants so they work similar to
% 'onlytextwidth', but the old version of `leftmiddleright` did not implement this behavior,
% and therefore, fails with the internal padding of minipages and spacing problems:
%    \partofpage{<X>
% \begin{minipage}{0.#1\textwidth}
%     \begin{flushleft}
%         #2
%     \end{flushleft}
% \end{minipage}<X>
% latex will insert spaces at each newline (e.g. <X>, same for the passed #2)
% and we do not want them!!
\def\uulm@leftmiddleright{\columns[c,onlytextwidth]\def\next{\column{.31\textwidth}}\next}
\def\endleftmiddleandright{\endcolumns}

\newcommand{\leftthenright}[2]{
    \halfpage{#1}
    \hfill
    \onslide<2->{\halfpage{#2}}
}

\newcommand{\rightthenleft}[2]{
    \onslide<2->{\halfpage{#1}}
    \hfill
    \halfpage{#2}
}

\newcommand{\leftmiddlethenright}[3]{
	\thirdpage{#1}
    \hfill
    \onslide<2->{\thirdpage{#2}}
    \hfill
    \onslide<3->{\thirdpage{#3}}
}

\newcommand{\rightmiddlethenleft}[3]{
	\onslide<3->{\thirdpage{#1}}
    \hfill
    \onslide<2->{\thirdpage{#2}}
    \hfill
    \thirdpage{#3}
}

\newcommand{\leftorright}[2]{ % only works in recording mode
    \ifrecording
    \onslide<1>{\halfpage{#1}}
    \onslide<2>{\hfill}
    \onslide<3>{\halfpage{#2}}
    \else
	\leftthenright{#1}{#2}
	\fi
}

\newcommand{\rightorleft}[2]{ % only works in recording mode
    \ifrecording
    \onslide<3>{\halfpage{#1}}
    \onslide<2>{\hfill}
    \onslide<1>{\halfpage{#2}}
    \else
	\rightthenleft{#1}{#2}
	\fi
}

\newcommand{\leftmiddleorright}[3]{ % only works in recording mode
    \ifrecording
    \onslide<1>{\thirdpage{#1}}
    \onslide<2>{\hfill}
    \onslide<3>{\thirdpage{#2}}
    \onslide<4>{\hfill}
    \onslide<5>{\thirdpage{#3}}
    \else
	\leftmiddlethenright{#1}{#2}{#3}
	\fi
}

\newcommand{\rightmiddleorleft}[3]{ % only works in recording mode
    \ifrecording
    \onslide<5>{\thirdpage{#1}}
    \onslide<4>{\hfill}
    \onslide<3>{\thirdpage{#2}}
    \onslide<2>{\hfill}
    \onslide<1>{\thirdpage{#3}}
    \else
	\rightmiddlethenleft{#1}{#2}{#3}
	\fi
}
% ---------------------------------------------


% ---------------------------------------------
% color boxes
% ---------------------------------------------
\tcbset{%
    uulm@basic-boxstyle/.style n args=4{title={\setlength{\parskip}{0ex}\vphantom{/}#2},colframe=#3!30,coltitle=black,fonttitle=\bfseries,left=#4,right=#4,top=#4,bottom=#4,#1},
    uulm@boxstyle/.style n args=3{uulm@basic-boxstyle={#1}{#2}{#3}{1mm},colback=#3!10},
    uulm@tightboxstyle/.style n args=3{uulm@basic-boxstyle={#1}{#2}{#3}{0mm},colback=white}
}

% name | color
\def\uulm@MakeNewBox#1#2{
% renew will not work if we define a box that does not already exist in beamer
% we could check this by \ifcsname #1\endcsname...\else...\fi
% however, for the moment this is not necessary
% in the definition #1 and #2 refer to the arguments of \uulm@MakeNewBox
% while ##1 and ##2 to refer to the arguments passed on to the new tcolorbox.
% therefore, with '\uulm@MakeNewBox{definition}{orange}', we create a new tcolorbox
% named 'definition' which wenn called with '\begin{definition}[top=10mm]{My title}...'
% will result in the option list 'uulm@boxstyle={top=10mm}{My title}{orange}'
\renewtcolorbox{#1}[2][]{uulm@boxstyle={##1}{##2}{#2}}
% here, we re-create the old macros (e.g. '\mydefinition')
% 'capture=minipage' ensures their behavior is similar to the previous one (the default for
% tcbox would be hbox and no longer fill the width)
\expandafter\newtcbox\csname my#1\endcsname[2][]{capture=minipage,uulm@boxstyle={##1}{##2}{#2}}
% now, we do the same for the tight-version of the boxes
\newtcolorbox{#1tight}[2][]{uulm@tightboxstyle={##1}{##2}{#2}}
\expandafter\newtcbox\csname my#1tight\endcsname[2][]{capture=minipage,uulm@tightboxstyle={##1}{##2}{#2}}
}
\uulm@MakeNewBox{definition}{orange}
\uulm@MakeNewBox{example}{blue}
\uulm@MakeNewBox{note}{red}
% ---------------------------------------------