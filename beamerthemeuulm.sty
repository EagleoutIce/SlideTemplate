% =============================================
% MAIN uulm-THEME
% =============================================

% ---------------------------------------------
% import packages
% ---------------------------------------------
\usepackage[utf8]{inputenc}
\usepackage{xargs} % used to define/renew commands with multiple optional parameters
\usepackage{color}
\usepackage{fitbox} % used to auto-scale long frame titles
\usepackage{tcolorbox} % used for color boxes (definition, example, note)
\usepackage{ifthen}
% ---------------------------------------------


% ---------------------------------------------
% general settings
% ---------------------------------------------
\beamertemplatenavigationsymbolsempty % remove the default navigation symbols

\graphicspath{{../pics/logos}{../pics/uulm}{../pics/nature}}

\newif\ifrecording % for enabling or disabling recording mode

\setlength{\parskip}{1.5ex} % set the parskip
\newcommand{\@minipagerestore}{\setlength{\parskip}{1.5ex}} % use parskip also in minipages (also used for tcolorbox)
% ---------------------------------------------


% ---------------------------------------------
% colors
% ---------------------------------------------
% uulm color scheme:
\definecolor{black}{HTML}{000000}
\definecolor{uulmlogoblue}{HTML}{89a2b3}
\definecolor{uulmblue}{HTML}{7D9AAA}
\definecolor{uulmaccent}{HTML}{A9A28D}
\definecolor{green}{HTML}{56AA1C}
\definecolor{red}{HTML}{A32638}
\definecolor{orange}{HTML}{DF6D07}
\definecolor{blue}{HTML}{26547C}

% beamer colors:
\setbeamercolor{frametitle}{fg=black}
\setbeamercolor{myfooter}{fg=white,bg=uulmaccent}
\setbeamercolor{mypagenumber}{fg=white,bg=red}
\setbeamercolor{titlebox}{fg=white,bg=red}
\setbeamercolor{subtitlebox}{fg=white,bg=uulmaccent}
\setbeamercolor{logobox}{bg=white}
\setbeamercolor{section in toc}{fg=black}
\setbeamercolor{subsection in toc}{fg=black}

\newcommand{\setfaculty}[1]{
    \ifthenelse{\equal{#1}{med}}{\setbeamercolor{mypagenumber}{fg=white,bg=blue}\setbeamercolor{titlebox}{fg=white,bg=blue}}{
        \ifthenelse{\equal{#1}{infIngPsy}}{\setbeamercolor{mypagenumber}{fg=white,bg=red}\setbeamercolor{titlebox}{fg=white,bg=red}}{
            \ifthenelse{\equal{#1}{math}}{\setbeamercolor{mypagenumber}{fg=white,bg=green}\setbeamercolor{titlebox}{fg=white,bg=green}}{
                \ifthenelse{\equal{#1}{nat}}{\setbeamercolor{mypagenumber}{fg=white,bg=orange}\setbeamercolor{titlebox}{fg=white,bg=orange}}{}
            }
        }
    }
}
% ---------------------------------------------


% ---------------------------------------------
% fonts
% ---------------------------------------------
\setbeamerfont{frametitle}{size=\LARGE, series=\bfseries}
\setbeamerfont{section in toc}{size=\large, series=\bfseries}

\setbeamerfont{itemize/enumerate subbody}{size=\normalsize}
\setbeamerfont{itemize/enumerate subsubbody}{size=\normalsize}
% ---------------------------------------------


% ---------------------------------------------
% list environments
% ---------------------------------------------
\setbeamercolor{item}{fg=black}
\setbeamertemplate{itemize items}[circle]
\setbeamertemplate{enumerate item}{\arabic{enumi}.}
\setbeamertemplate{enumerate subitem}{\arabic{enumii}.}
\setbeamertemplate{enumerate subsubitem}{\arabic{enumiii}.}
\setbeamertemplate{section in toc}[sections numbered]
% ---------------------------------------------


% ---------------------------------------------
% frame layout
% ---------------------------------------------
\renewcommandx{\maketitle}[2][1=apr21-o25a,2=150]{
    {
    \usebackgroundtemplate{\includegraphics[trim=0 0 0 #2,clip,width=\paperwidth]{#1}}
    \begin{frame}[plain]
        \vskip0pt plus 1filll
        \begin{beamercolorbox}[wd=\paperwidth,ht=4.5ex,dp=2ex,right]{titlebox}
            \LARGE\textbf{\inserttitle}\hspace*{20pt}
        \end{beamercolorbox}%
        \nointerlineskip%
        \begin{beamercolorbox}[wd=\paperwidth,ht=2.25ex,dp=1ex,right]{subtitlebox}
            \small
            \ifx \insertsubtitle \empty \else \insertsubtitle\ $\vert$ \fi
            \insertauthor\
            \ifx \insertdate \empty \else $\vert$ \insertdate \fi
            \hspace*{20pt}
        \end{beamercolorbox}%
        \nointerlineskip%
        \begin{beamercolorbox}[wd=\paperwidth,ht=4.5ex,dp=2ex,left]{logobox}
            \centering
            \vspace{-1ex}
            \hspace{10pt}
            \includegraphics[height=4.5ex]{sp} % SPECIFY INSTITUTE LOGO HERE
            \hfill
            \includegraphics[height=4.5ex]{uulm}
            \hspace{10pt}
        \end{beamercolorbox}%
    \end{frame}
    }
}

\setbeamertemplate{frametitle}{
    \vspace{20pt}%
    \fitbox[maxheight=2.5ex,minheight=0pt,maxwidth=\textwidth,minwidth=0pt]{%
        \vphantom{/}\insertframetitle{}%
    }%
}

\setbeamertemplate{footline}{
    \hbox{%
        \begin{beamercolorbox}[wd=0.93\textwidth,ht=3mm,dp=1.5mm,left]{myfooter}
            \hspace{0.03\textwidth}
            \insertshortauthor
            \hfill
            \insertshorttitle\
            \ifx \insertsubtitle \empty \else {-- \insertshortsubtitle} \fi
            \ifx \insertsectionhead \empty \else {-- \thesection.~\insertsectionhead} \fi
            \hspace{0.03\textwidth}
        \end{beamercolorbox}%
        \begin{beamercolorbox}[wd=0.07\textwidth,ht=3mm,dp=1.5mm,center]{mypagenumber}
            \insertframenumber
        \end{beamercolorbox}%
    }%
}
% ---------------------------------------------


% ---------------------------------------------
% table of contents
% ---------------------------------------------
\AtBeginSection{
    \begin{frame}{\thesection.~\insertsection}
        \setlength{\parskip}{0ex}
        \vfill
        \tableofcontents[currentsection,hideothersubsections]
    \end{frame}
}

\newcommand{\lectureoverview}{
    \begin{frame}{\inserttitle}
        \setlength{\parskip}{0ex}
        \tableofcontents
    \end{frame}
}
% ---------------------------------------------


% ---------------------------------------------
% content layout
% ---------------------------------------------
\newcommand{\halfpage}[1]{\partofpage{48}{#1}}

\newcommand{\thirdpage}[1]{\partofpage{31}{#1}}

\usepackage{adjustbox}
\newcommand{\partofpage}[2]{
	\begin{minipage}{0.#1\textwidth}
			\begin{flushleft}
				#2
			\end{flushleft}
	\end{minipage}
}

% corresponds to '\halfpage', however, with the new columns we could use larger values
% (same for thirdnext)
\def\halfnext{.489\textwidth}
% corresponds to '\thirdpage'
\def\thirdnext{.31\textwidth}
\def\uulm@cols@error{\PackageError{beamerthemeuulm}{The layout <TODO> you selected does not allow another \string\mynextcolumn\space (page: \thepage, frame: \insertframenumber,\on@line)}{Either remove the command, or choose another Layout}}

\newcommand\leftandright[2]{%
    \halfpage{#1}%
    \hfill
    \halfpage{#2}%
}

\newcommand\leftmiddleandright[3]{%
    \thirdpage{#1}%
    \hfill
    \thirdpage{#2}%
    \hfill
    \thirdpage{#3}%
}

\newcommand\leftthenright[2]{%
    \halfpage{#1}%
    \hfill
    \onslide<2->{\halfpage{#2}}%
}

\newcommand\rightthenleft[2]{
    \onslide<2->{\halfpage{#1}}
    \hfill
    \halfpage{#2}
}

\newcommand\leftmiddlethenright[3]{%
    \thirdpage{#1}%
    \hfill
    \onslide<2->{\thirdpage{#2}}%
    \hfill
    \onslide<3->{\thirdpage{#2}}%
}

\newcommand\rightmiddlethenleft[3]{%
    \onslide<3->{\thirdpage{#1}}%
    \hfill
    \onslide<2->{\thirdpage{#2}}\hfill\thirdpage{#2}%
}

\newcommand\leftorright[2]{%
\ifrecording
    \onslide<1>{\halfpage{#1}}%
    \onslide<2>{\hfill}%
    \onslide<3>{\halfpage{#2}}%
\else
    \leftthenright{#1}{#2}%
\fi
}

\newcommand\rightorleft[2]{%
\ifrecording
    \onslide<3>{\halfpage{#1}}%
    \onslide<2>{\hfill}%
    \onslide<1>{\halfpage{#2}}%
\else
    \rightthenleft{#1}{#2}%
\fi
}

\newcommand\leftmiddleorright[3]{%
\ifrecording
    \onslide<1>{\thirdpage{#1}}%
    \onslide<2>{\hfill}%
    \onslide<3>{\thirdpage{#2}}%
    \onslide<4>{\hfill}%
    \onslide<5>{\thirdpage{#3}}%
\else
    \leftmiddlethenright{#1}{#2}{#3}%
\fi
}

\newcommand\rightmiddleorleft[3]{%
\ifrecording
    \onslide<5>{\thirdpage{#1}}%
    \onslide<4>{\hfill}%
    \onslide<3>{\thirdpage{#2}}%
    \onslide<2>{\hfill}%
    \onslide<1>{\thirdpage{#3}}%
\else
    \rightmiddlethenleft{#1}{#2}{#3}%
\fi
}

% here, we configure the defaults
\def\uulm@cols@extra{} % no extra options for the columns environment
% init | step
\def\uulm@cols@animation#1#2{%
    \def\uulm@cols@anim@step{#1}% defines the increment (+/-) each step
    \def\uulm@cols@anim@suff{#2}% '-' for keep, '' for forget
}
\def\uulm@cols@anim@init{1} % start on the first column
\def\uulm@cols@anim@step@sign{+} % count up (if there is anything to count)
\newdimen\uulm@cols@total@width % holds the column width
\def\uulm@cols@widths@max{100} % the maximum number to be used for widths
\pgfqkeys{/uulm columns}{
  /uulm columns/.search also = {/uulm columns/align, /uulm columns/extras},
  align/c/.code              = \def\uulm@cols@valign{c},
  align/t/.code              = \def\uulm@cols@valign{t},
  align/b/.code              = \def\uulm@cols@valign{b},
  align/T/.code              = \def\uulm@cols@valign{T},
  align/T/.code              = \def\uulm@cols@valign{T},
  width/.code                = \setlength\uulm@cols@total@width{#1},
  widths/.code               = \def\uulm@cols@widths{#1},
  extra/columns/.code        = \def\uulm@cols@extra{#1},
  % supply custom columns arguments with columns=...
  extra/custom/.code         = #1, % just execute a custom configuration
  columns/.code              = \def\uulm@columncount{#1},
  animation/.is choice,
  animation/keep/.code       = \uulm@cols@animation{1}{-},
  % forget will behave like keep without recording
  animation/forget/.code     = \ifrecording\uulm@cols@animation{1}{}\else\uulm@cols@animation{1}{-}\fi,
  animation/none/.code       = \uulm@cols@animation{0}{-},
  % explicitly do not allow just writing 'none'
  keep/.forward to           =  /uulm columns/animation=keep,
  forget/.forward to         =  /uulm columns/animation=forget,
  reverse/.code              =  \def\uulm@cols@anim@init{\uulm@columncount}\def\uulm@cols@anim@step@sign{-},
  % by overwriting the style '/uulm columns/@defaults',
  % the user can change these defaults
  @defaults/.style           = {
    c, % center align
    columns = 1, animation=none,
    widths = {}, % use default widths
    width = .95\linewidth% TODO: margins; by default, use the complete line
  }
}

\newcounter{uulm@cols@current}
\newcounter{uulm@cols@currentanim}
% TODO: if recording support!
\def\uulm@cols@init{%
    \c@uulm@cols@current=0 % reset the counter locally to the group
    % initialize the current animation counter
    \c@uulm@cols@currentanim=\uulm@cols@anim@init
    % activate(/overwrite) the '\mynextcolumn' macro
    \let\mynextcolumn\uulm@mynextcolumn
    % deal with 'widths'
    \@tempcnta0% temporary counter
    % initialize the remaining width for all columns
    \let\uulm@cols@remaining@width\uulm@cols@widths@max
    \@for\@width:=\uulm@cols@widths\do{%
        % define the width for column with number '\@tempcnta'
        \protected@csedef{uulm@cols@col@\number\@tempcnta}{\the\dimexpr\uulm@cols@total@width*\@width/\uulm@cols@widths@max\relax}%
        % reduce remaining (only int)
        \edef\uulm@cols@remaining@width{\the\numexpr\uulm@cols@remaining@width-\@width}%
        % step the counter
        \advance\@tempcnta1\relax
        % too many?
        \ifnum\number\@tempcnta>\uulm@columncount\relax
            \PackageError{beamerthemeuulm}{You specified '\number\uulm@columncount' columns, but supplied more lengths to widths (\uulm@cols@widths) (page: \thepage, frame: \insertframenumber,\on@line)}{Reduce the amount of widths supplied or increase the number of columns}
        \fi
    }%
    \ifnum\uulm@cols@remaining@width<0\relax
        \PackageError{beamerthemeuulm}{Widths (\uulm@cols@widths) sum up to more than the allowed max '\uulm@cols@widths@max' (page: \thepage, frame: \insertframenumber,\on@line)}{Please current the supplied widths}
    \fi
    % for the remaining columns, distribute remaining width evenly
    \edef\@remainingcols{\the\numexpr\uulm@columncount-\@tempcnta}%
    \typeout{Using auto-width for \@remainingcols\space columns}%
    % NOTE: maybe a warning if? \ifnum\uulm@cols@remaining@width>0
    % To tell the user about auto-filling besides typeout?
    % TODO: warning in general if width is below max width?
    \ifnum\@remainingcols>0
        \edef\@remainingcolwidth{\the\dimexpr
        \uulm@cols@total@width*
        \uulm@cols@remaining@width/\uulm@cols@widths@max/\@remainingcols}%
        % TODO: errors if too many columns?
        \@whilenum\@tempcnta<\uulm@columncount\do{%
            \protected@csedef{uulm@cols@col@\number\@tempcnta}{\@remainingcolwidth}%
            \advance\@tempcnta1\relax
        }%
    \fi
    % issue the first column
    % NOTE: we don't guard if 'columns' is below 1
    \mynextcolumn
}

% TODO: animation % TODO: error if used more % TODO: keep
% TODO: animations that hide again

\def\uulm@mynextcolumn{
    % issue an error if too many columns
    \ifnum\number\c@uulm@cols@current<\uulm@columncount\else
        \uulm@cols@error
    \fi
    \typeout{Creating col: \the\c@uulm@cols@current\space on slide: \the\c@uulm@cols@currentanim\uulm@cols@anim@suff, page: \thepage\space (width: \csuse{uulm@cols@col@\number\c@uulm@cols@current})}%
    % regarding the width, we use the macro 'uulm@cols@col@\number\c@uulm@cols@current'
    \edef\@tmp{\noexpand\column<\number\c@uulm@cols@currentanim\uulm@cols@anim@suff>%
    % the width of the column
    {\csuse{uulm@cols@col@\number\c@uulm@cols@current}}}\@tmp
    % update the current animation accordingly
    \global\advance\c@uulm@cols@currentanim\uulm@cols@anim@step@sign\uulm@cols@anim@step\relax
    % increase the current column counter (e.g. for error checking)
    \global\advance\c@uulm@cols@current1\relax
}

% TODO: onlytextwidth
\newenvironment{mycolumns}[1][]{\begingroup
\pgfqkeys{/uulm columns}{@defaults, #1}%
\begin{columns}[onlytextwidth,\uulm@cols@valign, \uulm@cols@extra]
    % TODO: other parameters like onlytextwith
    \uulm@cols@init
}{\end{columns}\endgroup}


% ---------------------------------------------


% ---------------------------------------------
% color boxes
% ---------------------------------------------
\tcbset{%
    % by definig styles we avoid their replication
    uulm@basic-boxstyle/.style n args=4{
        title={#2},
        colframe=#3!30,
        coltitle=black,
        before title={\setlength{\parskip}{0ex}\vphantom{/}},
        fonttitle=\bfseries,
        left=#4, right=#4, top=#4, bottom=#4,
        #1
    },
    % style definition for the normal boxes
    uulm@boxstyle/.style n args=3{uulm@basic-boxstyle={#1}{#2}{#3}{1mm}, colback=#3!10},
    % style definition for their tight variant
    uulm@tightboxstyle/.style n args=3{uulm@basic-boxstyle={#1}{#2}{#3}{0mm}, colback=white}
}

% name | color
\def\uulm@MakeNewBox#1#2{
    % renew will not work if we define a box that does not already exist in beamer
    % we could check this by \ifcsname #1\endcsname...\else...\fi
    % however, for the moment this is not necessary
    % in the definition #1 and #2 refer to the arguments of \uulm@MakeNewBox
    % while ##1 and ##2 to refer to the arguments passed on to the new tcolorbox.
    % therefore, with '\uulm@MakeNewBox{definition}{orange}', we create a new tcolorbox
    % named 'definition' which wenn called with '\begin{definition}[top=10mm]{My title}...'
    % will result in the option list 'uulm@boxstyle={top=10mm}{My title}{orange}'
    \renewtcolorbox{#1}[2][]{uulm@boxstyle={##1}{##2}{#2}}
    % here, we re-create the old macros (e.g. '\mydefinition')
    % 'capture=minipage' ensures their behavior is similar to the previous one (the default for
    % tcbox would be hbox and no longer fill the width)
    \expandafter\newtcbox\csname my#1\endcsname[2][]{capture=minipage,uulm@boxstyle={##1}{##2}{#2}}
    % now, we do the same for the tight-version of the boxes
    \newtcolorbox{#1tight}[2][]{uulm@tightboxstyle={##1}{##2}{#2}}
    \expandafter\newtcbox\csname my#1tight\endcsname[2][]{capture=minipage,uulm@tightboxstyle={##1}{##2}{#2}}
}

% now we simply define the boxes by name and color
\uulm@MakeNewBox{definition}{orange}
\uulm@MakeNewBox{example}{blue}
\uulm@MakeNewBox{note}{red}
% ---------------------------------------------